name: Update Notion When PR Is Merged Into Master

on:
  pull_request:
    branches:
      - master
    types: [closed]

jobs:
  update-notion:
    if: |
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'master'
    runs-on: ubuntu-latest

    steps:
      - name: Extract Notion URL from PR body
        id: extract
        run: |
          BODY="${{ github.event.pull_request.body }}"

          # Buscar URL de Notion en el cuerpo del PR
          NOTION_URL=$(echo "$BODY" | grep -oE 'https://www\.notion\.so/[^\)]+' || true)

          if [ -z "$NOTION_URL" ]; then
            echo "No Notion URL found in PR body. Skipping."
            echo "page_id=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extraer el page_id (32 chars hex)
          PAGE_ID=$(echo "$NOTION_URL" | grep -oE '[0-9a-f]{32}' || true)

          if [ -z "$PAGE_ID" ]; then
            echo "No Page ID found in URL. Skipping."
            echo "page_id=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "page_id=$PAGE_ID" >> $GITHUB_OUTPUT

      - name: Update Notion page status + deploy date
        if: steps.extract.outputs.page_id != ''
        run: |
          MERGE_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          curl -X PATCH "https://api.notion.com/v1/pages/${{ steps.extract.outputs.page_id }}" \
          -H "Authorization: Bearer ${{ secrets.NOTION_TOKEN }}" \
          -H "Content-Type: application/json" \
          -H "Notion-Version: 2022-06-28" \
          --data "{
            \"properties\": {
              \"Estatus\": {
                \"status\": { \"name\": \"Deployado\" }
              },
              \"Fecha deploy\": {
                \"date\": { \"start\": \"${MERGE_DATE}\" }
              }
            }
          }"
